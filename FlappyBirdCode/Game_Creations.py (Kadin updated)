import pygame
import random
import time
import math

# -----------------------------------
# COLORS
# -----------------------------------
Green = (0, 200, 0)
RED = (255, 0, 0)
LIGHT_GREEN = (0, 255, 0)
ORANGE = (255, 165, 0)
BLUE = (0, 0, 255)
PURPLE = (170, 0, 255)
PINK = (255, 105, 180)
WHITE = (255, 255, 255)
BLACK = (0, 0, 0)

# -----------------------------------
# COIN POWER-UP COLORS
# -----------------------------------
coin_colors = {
    "red": RED,
    "green": LIGHT_GREEN,
    "orange": ORANGE,
    "blue": BLUE,
    "purple": PURPLE,
    "pink": PINK
}

# -----------------------------------
# SCORE SQUARES
# -----------------------------------
score_squares = {
    "+5": 5,
    "+10": 10,
    "+25": 25
}

# -----------------------------------
# PIPE FUNCTIONS
# -----------------------------------
def spawn_pipe(swidth, sheight, pwidth, pgap):
    pheight = random.randint(80, sheight - 200)
    bottom = pygame.Rect(swidth, pheight + pgap, pwidth, sheight - (pheight + pgap))
    top = pygame.Rect(swidth, 0, pwidth, pheight)
    return [bottom, top]


def draw_pipes(screen, pipes):
    for p in pipes:
        pygame.draw.rect(screen, Green, p)


def move_pipes(pipes, speed):
    for p in pipes:
        p.centerx -= speed
    return [p for p in pipes if p.right > 0]


# -----------------------------------
# COLLISION LOGIC
# -----------------------------------
def check_collision(bird, pipes, sheight, state):
    now = time.time()

    # End immunity after timer runs out
    if state["immunity"] and now >= state["immunity_end"]:
        state["immunity"] = False

    # Pipe collisions
    for p in pipes:
        if bird.colliderect(p):
            if not state["immunity"]:
                state["lives"] -= 1
                if state["lives"] <= 0:
                    return False
                else:
                    # brief immunity after hit
                    state["immunity"] = True
                    state["immunity_end"] = now + 1
                    return True

    # Ground collision
    if bird.bottom >= sheight:
        state["lives"] = 0
        return False

    # Ceiling collision
    if bird.top <= 0:
        if not state["immunity"]:
            state["lives"] -= 1
            if state["lives"] <= 0:
                return False
            else:
                state["immunity"] = True
                state["immunity_end"] = now + 1
                return True

    return True


# -----------------------------------
# SCORE DISPLAY
# -----------------------------------
def draw_score(screen, font, score, lives):
    t = font.render(f"Score: {int(score)}   Lives: {lives}", True, (0, 0, 0))
    screen.blit(t, (10, 10))


# -----------------------------------
# ITEM SPAWNING (COINS + SCORE SQUARES)
# -----------------------------------
def spawn_item(screen_width, screen_height):
    y = random.randint(60, screen_height - 60)

    # Weighted spawn:
    # 80% = coin power-ups
    # 20% = score squares
    if random.random() < 0.8:
        color = random.choice(list(coin_colors.keys()))
        rect = pygame.Rect(screen_width, y, 20, 20)
        return rect, color, time.time()
    else:
        kind = random.choice(list(score_squares.keys()))
        rect = pygame.Rect(screen_width, y, 30, 30)
        return rect, kind, time.time()


def move_items(items):
    updated = []
    for rect, color, born in items:
        rect.centerx -= 3
        if rect.right > 0:
            updated.append((rect, color, born))
    return updated


# -----------------------------------
# ITEM DRAWING
# -----------------------------------
def draw_item(screen, rect, color, born):
    # If this is a SCORE SQUARE
    if color in score_squares:
        pygame.draw.rect(screen, WHITE, rect)  # background
        pygame.draw.rect(screen, BLACK, rect, 2)  # border

        font = pygame.font.SysFont(None, 24)
        text = font.render(color, True, BLACK)
        screen.blit(
            text,
            (rect.centerx - text.get_width() // 2,
             rect.centery - text.get_height() // 2)
        )
        return

    # Otherwise draw a COIN with glow
    elapsed = time.time() - born
    pulse = 6 * abs(math.sin(elapsed * 3)) + 10

    glow = pygame.Surface((rect.width + 30, rect.height + 30), pygame.SRCALPHA)
    pygame.draw.circle(
        glow,
        (*coin_colors[color], 80),
        (rect.width // 2 + 15, rect.height // 2 + 15),
        int(pulse + 10)
    )
    screen.blit(glow, (rect.centerx - rect.width // 2 - 15,
                       rect.centery - rect.height // 2 - 15))

    pygame.draw.circle(screen, coin_colors[color], rect.center, 10)


# -----------------------------------
# ITEM COLLISIONS & EFFECTS
# -----------------------------------
def handle_item_collision(items, bird, state):
    updated = []
    now = time.time()

    for rect, color, born in items:

        if bird.colliderect(rect):

            # -------- SCORE SQUARES (+5, +10, +25) --------
            if color in score_squares:
                bonus = score_squares[color]
                state["score"] += bonus
                state["reward_popup"] = (f"+{bonus} POINTS!", now + 2)
                continue  # remove this item completely

            # -------- POWER-UP COINS --------
            if color == "red":
                state["lives"] += 2
                state["reward_popup"] = ("+2 LIVES!", now + 2)

            elif color == "green":
                state["pipe_shrink"] = True
                state["pipe_restore_time"] = now + 8
                state["pipe_width"] = state["base_pipe_width"] // 2
                state["pipe_gap"] = int(state["base_pipe_gap"] * 1.5)
                state["reward_popup"] = ("SMALL PIPES!", now + 2)

            elif color == "orange":
                state["immunity"] = True
                state["immunity_end"] = now + 8
                state["reward_popup"] = ("IMMUNITY!", now + 2)

            elif color == "blue":
                state["double_points"] = True
                state["double_end"] = now + 8
                state["reward_popup"] = ("DOUBLE POINTS!", now + 2)

            elif color == "purple":
                state["bird_shrink"] = True
                state["shrink_end"] = now + 8
                state["reward_popup"] = ("SMALL BIRD!", now + 2)

            elif color == "pink":
                state["pipe_slow"] = True
                state["slow_end"] = now + 8
                state["reward_popup"] = ("SLOW PIPES!", now + 2)

            # Normal coin gives base 5 points
            state["score"] += 5

        else:
            updated.append((rect, color, born))

    return updated


# -----------------------------------
# RESTORE PIPE MODIFICATIONS
# -----------------------------------
def restore_pipes(state):
    state["pipe_width"] = state["base_pipe_width"]
    state["pipe_gap"] = state["base_pipe_gap"]
    state["pipe_shrink"] = False
